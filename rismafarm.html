<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RISMA FARM | Bertani, Berbisnis, Berbagi</title>

  <link rel="stylesheet" href="/style.css" />

  <!-- DATA -->
  <script src="/rismafarm.js"></script>

  <!-- NAVBAR -->
  <script src="/navbar2.js"></script>
</head>

<body>

<script>
  renderNavbar("rismafarm", "public");
</script>

<main class="container">

  <!-- 1. HEADER -->
  <section class="bank-header" style="margin-bottom:20px">
    <img src="/img/risma_1.png" class="bank-logo">
    <h1 class="bank-title">RISMA FARM</h1>
    <p class="muted" style="text-align:center">
      Bertani Â· Berbisnis Â· Berbagi
    </p>
  </section>

  <!-- 2. PILIH MUSIM -->
  <section class="card" style="text-align:center">
    <select id="pilihMusim" class="select-center"></select>
    <div id="infoMusim" class="muted" style="margin-top:8px"></div>
  </section>

  <!-- 3. MODAL -->
  <section class="card">
    <h2>ðŸ’° Modal</h2>
    <div id="modalBox"></div>
  </section>

  <!-- 4. TABEL BIAYA -->
  <section class="card">
    <h2>ðŸ’¸ Tabel Biaya</h2>
    <div id="tabelBiaya"></div>
  </section>

  <!-- 5. PANEN PER KOMODITAS -->
  <section class="card">
    <h2>ðŸŒ¾ Panen per Komoditas</h2>
    <div id="tabelPanen"></div>
  </section>

  <!-- 6. LABA & BAGI HASIL -->
  <section class="card" id="labaSection"></section>

  <!-- 7. RIWAYAT -->
  <section class="card" id="riwayatSection">
    <h2>ðŸ“œ Riwayat Transaksi</h2>
    <div id="riwayatTransaksi"></div>
    <div class="pagination" id="pagination"></div>
  </section>

</main>

<script>
/* ===============================
   UTIL
================================ */
const rupiah = n => Number(n||0).toLocaleString("id-ID");
const tgl = t => new Date(t).toLocaleDateString("id-ID",{day:"2-digit",month:"long",year:"numeric"});

/* ===============================
   DATA MUSIM
================================ */
const musimKeys = Object.keys(RISMA_FARM.musim||{});
let musimAktif = RISMA_FARM.musim[musimKeys[0]];

/* ===============================
   DROPDOWN MUSIM
================================ */
const select = document.getElementById("pilihMusim");
musimKeys.forEach(k=>{
  const m = RISMA_FARM.musim[k];
  const o = document.createElement("option");
  o.value = k;
  o.textContent = m.label;
  select.appendChild(o);
});
select.onchange = () => {
  musimAktif = RISMA_FARM.musim[select.value];
  renderAll();
};

/* ===============================
   INFO MUSIM
================================ */
function renderInfoMusim(){
  document.getElementById("infoMusim").innerHTML = `
    <strong>${musimAktif.label}</strong><br>
    ${musimAktif.lokasi}
  `;
}

/* ===============================
   MODAL
================================ */
function renderModal(){
  let html = `<table class="table">
    <tr><th>No</th><th>Nama</th><th>Nilai</th></tr>`;
  let i=1,total=0;
  Object.entries(musimAktif.modal||{}).forEach(([n,v])=>{
    total+=Number(v);
    html+=`<tr><td>${i++}</td><td>${n}</td><td>Rp ${rupiah(v)}</td></tr>`;
  });
  html+=`<tr class="total"><td colspan="2"><strong>Total</strong></td>
    <td><strong>Rp ${rupiah(total)}</strong></td></tr></table>`;
  document.getElementById("modalBox").innerHTML=html;
}

/* ===============================
   BIAYA
================================ */
function renderBiaya(){
  let total=0;
  let html=`<table class="table">
  <tr><th>No</th><th>Keterangan</th><th>Harga</th></tr>`;
  musimAktif.biaya.forEach((b,i)=>{
    total+=b.jumlah;
    html+=`<tr><td>${i+1}</td><td>${b.keterangan}</td><td>Rp ${rupiah(b.jumlah)}</td></tr>`;
  });
  html+=`<tr class="total"><td colspan="2"><strong>Total</strong></td>
  <td><strong>Rp ${rupiah(total)}</strong></td></tr></table>`;
  document.getElementById("tabelBiaya").innerHTML=html;
}

/* ===============================
   PANEN PER KOMODITAS
================================ */
function renderPanen(){
  const box=document.getElementById("tabelPanen");
  box.innerHTML="";
  const grup={};
  musimAktif.panen.forEach(p=>{
    if(!grup[p.komoditas]) grup[p.komoditas]=[];
    grup[p.komoditas].push(p);
  });

  Object.entries(grup).forEach(([kom,arr])=>{
    let total=0;
    let html=`<h3>${kom}</h3><table class="table">
    <tr><th>No</th><th>Tanggal</th><th>Surplus</th></tr>`;
    arr.forEach((p,i)=>{
      const s=p.nilai-(p.biayaPanen||0);
      total+=s;
      html+=`<tr><td>${i+1}</td><td>${tgl(p.tanggal)}</td><td>Rp ${rupiah(s)}</td></tr>`;
    });
    html+=`<tr class="total"><td colspan="2"><strong>Total</strong></td>
    <td><strong>Rp ${rupiah(total)}</strong></td></tr></table>`;
    box.innerHTML+=html;
  });
}

/* ===============================
   LABA & BAGI HASIL (DINAMIS)
================================ */
function renderLaba(){
  const omzet=musimAktif.panen.reduce((a,b)=>a+b.nilai,0);
  const biaya=musimAktif.biaya.reduce((a,b)=>a+b.jumlah,0);
  const panenBiaya=musimAktif.panen.reduce((a,b)=>a+(b.biayaPanen||0),0);
  const laba=omzet-biaya-panenBiaya;

  let html=`<h2>ðŸ“Š Laba & Bagi Hasil</h2>
  <div class="stat"><small>Laba Bersih</small>
  <strong class="success">Rp ${rupiah(laba)}</strong></div>
  <table class="table"><tr><th>Pihak</th><th>Bagian</th></tr>`;

  Object.entries(musimAktif.skema.pembagian||{}).forEach(([n,p])=>{
    html+=`<tr><td>${n}</td><td>Rp ${rupiah(laba*p/100)}</td></tr>`;
  });
  html+=`</table>`;
  document.getElementById("labaSection").innerHTML=html;
}

/* ===============================
   RIWAYAT FULL
================================ */
const PER_PAGE=5;
let riwayat=[],page=1;

function kumpulkanRiwayat(){
  riwayat=[];
  musimAktif.biaya.forEach(b=>riwayat.push({
    tanggal:b.tanggal,tipe:"Biaya",ket:b.keterangan,nilai:-b.jumlah,bukti:b.bukti
  }));
  musimAktif.panen.forEach(p=>riwayat.push({
    tanggal:p.tanggal,tipe:`Panen ${p.komoditas}`,
    ket:`Omzet Rp ${rupiah(p.nilai)}<br>Biaya Panen Rp ${rupiah(p.biayaPanen||0)}`,
    nilai:p.nilai-(p.biayaPanen||0),bukti:p.bukti
  }));
  riwayat.sort((a,b)=>new Date(b.tanggal)-new Date(a.tanggal));
}

function renderRiwayat(){
  const box=document.getElementById("riwayatTransaksi");
  const pag=document.getElementById("pagination");
  box.innerHTML=""; pag.innerHTML="";
  riwayat.slice((page-1)*PER_PAGE,page*PER_PAGE).forEach(r=>{
    box.innerHTML+=`
    <div class="riwayat-full">
      <div class="riwayat-date">${tgl(r.tanggal)}</div>
      <strong>${r.tipe}</strong>
      <div class="muted">${r.ket}</div>
      <div class="${r.nilai>=0?'success':'danger'}">Rp ${rupiah(r.nilai)}</div>
      ${r.bukti?`<img src="${r.bukti}" class="bukti">`:""}
    </div>`;
  });
  for(let i=1;i<=Math.min(5,Math.ceil(riwayat.length/PER_PAGE));i++){
    const b=document.createElement("button");
    b.textContent=i;
    if(i===page) b.classList.add("active");
    b.onclick=()=>{page=i;renderRiwayat();
      document.getElementById("riwayatSection").scrollIntoView({behavior:"smooth"});
    };
    pag.appendChild(b);
  }
}

/* ===============================
   INIT
================================ */
function renderAll(){
  renderInfoMusim();
  renderModal();
  renderBiaya();
  renderPanen();
  renderLaba();
  kumpulkanRiwayat();
  renderRiwayat();
}
renderAll();
</script>

</body>
</html>