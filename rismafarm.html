<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RISMA FARM | Bertani, Berbisnis, Berbagi</title>

  <link rel="stylesheet" href="/style.css" />

  <!-- DATA -->
  <script src="/rismafarm.js"></script>

  <!-- NAVBAR -->
  <script src="/navbar2.js"></script>
</head>

<body>

<script>
  renderNavbar("rismafarm", "public");
</script>

<main class="container">

  <!-- 1. HEADER -->
  <section class="bank-header" style="margin-bottom:20px">
    <img src="/img/risma_1.png" class="bank-logo">
    <h1 class="bank-title">RISMA FARM</h1>
    <p class="muted" style="text-align:center">
      Bertani Â· Berbisnis Â· Berbagi
    </p>
  </section>

  <!-- 2. PILIH MUSIM -->
  <section class="card" style="text-align:center">
    <select id="pilihMusim" class="select-elegan"></select>
  </section>

  <!-- 3. MODAL -->
  <section class="card" id="modalSection"></section>

  <!-- 4. BIAYA -->
  <section class="card">
    <h2>ðŸ’¸ Tabel Biaya</h2>
    <div id="tabelBiaya"></div>
  </section>

  <!-- 5. PANEN -->
  <section class="card">
    <h2>ðŸŒ¾ Panen per Komoditas</h2>
    <div id="tabelPanen"></div>
  </section>

  <!-- 6. LABA -->
  <section class="card" id="labaSection"></section>

  <!-- 7. RIWAYAT -->
  <section class="card" id="riwayatSection">
    <h2>ðŸ“œ Riwayat Transaksi</h2>
    <div id="riwayatTransaksi"></div>
    <div class="pagination" id="pagination"></div>
  </section>

</main>

<script>
/* ===============================
   UTIL
================================ */
const rupiah = n => Number(n||0).toLocaleString("id-ID");
const tgl = t => new Date(t).toLocaleDateString("id-ID",{day:"2-digit",month:"long",year:"numeric"});

/* ===============================
   MUSIM
================================ */
const musimKeys = Object.keys(RISMA_FARM.musim || {});
let musimAktif = RISMA_FARM.musim[musimKeys[0]];

/* ===============================
   DROPDOWN MUSIM
================================ */
const select = document.getElementById("pilihMusim");
musimKeys.forEach(k=>{
  const o = document.createElement("option");
  o.value = k;
  o.textContent = RISMA_FARM.musim[k].label;
  select.appendChild(o);
});
select.onchange = ()=>{
  musimAktif = RISMA_FARM.musim[select.value];
  renderAll();
};

/* ===============================
   MODAL
================================ */
function renderModal(){
  let html = `<h2>ðŸ’° Modal ${musimAktif.label}</h2><ul>`;
  Object.entries(musimAktif.modal||{}).forEach(([n,v])=>{
    html += `<li>${n} â€” <strong>Rp ${rupiah(v)}</strong></li>`;
  });
  html += `</ul>`;
  document.getElementById("modalSection").innerHTML = html;
}

/* ===============================
   BIAYA
================================ */
function renderBiaya(){
  let total=0, html=`<table class="table">
    <tr><th>No</th><th>Keterangan</th><th>Harga</th></tr>`;
  musimAktif.biaya.forEach((b,i)=>{
    total+=b.jumlah;
    html+=`<tr><td>${i+1}</td><td>${b.keterangan}</td><td>Rp ${rupiah(b.jumlah)}</td></tr>`;
  });
  html+=`<tr class="total"><td colspan="2">Total</td><td>Rp ${rupiah(total)}</td></tr></table>`;
  document.getElementById("tabelBiaya").innerHTML=html;
}

/* ===============================
   PANEN PER KOMODITAS
================================ */
function renderPanen(){
  const box=document.getElementById("tabelPanen");
  box.innerHTML="";
  const grup={};

  musimAktif.panen.forEach(p=>{
    if(!grup[p.komoditas]) grup[p.komoditas]=[];
    grup[p.komoditas].push(p);
  });

  Object.entries(grup).forEach(([komo,list])=>{
    let html=`<h3>${komo}</h3><table class="table">
      <tr><th>No</th><th>Tanggal</th><th>Surplus</th></tr>`;
    list.forEach((p,i)=>{
      const surplus=p.nilai-(p.biayaPanen||0);
      html+=`<tr><td>${i+1}</td><td>${tgl(p.tanggal)}</td><td>Rp ${rupiah(surplus)}</td></tr>`;
    });
    html+=`</table>`;
    box.innerHTML+=html;
  });
}

/* ===============================
   LABA
================================ */
function renderLaba(){
  const omzet=musimAktif.panen.reduce((a,b)=>a+b.nilai,0);
  const biaya=musimAktif.biaya.reduce((a,b)=>a+b.jumlah,0);
  const biayaPanen=musimAktif.panen.reduce((a,b)=>a+(b.biayaPanen||0),0);
  const laba=omzet-biaya-biayaPanen;
  const s=musimAktif.skema.pembagian;

  document.getElementById("labaSection").innerHTML=`
    <h2>ðŸ“Š Laba & Bagi Hasil</h2>
    <p>Laba Bersih: <strong class="success">Rp ${rupiah(laba)}</strong></p>
    <ul>
      <li>Pelaksana (${s.pelaksana}%) â€” Rp ${rupiah(laba*s.pelaksana/100)}</li>
      <li>RISMA (${s.risma}%) â€” Rp ${rupiah(laba*s.risma/100)}</li>
      <li>Manajemen (${s.manajemen}%) â€” Rp ${rupiah(laba*s.manajemen/100)}</li>
    </ul>`;
}

/* ===============================
   RIWAYAT
================================ */
const PER_PAGE=5; let page=1, riwayat=[];

function kumpulkanRiwayat(){
  riwayat=[];
  musimAktif.biaya.forEach(b=>riwayat.push({tipe:"Biaya",tanggal:b.tanggal,keterangan:b.keterangan,nilai:-b.jumlah,foto:b.foto}));
  musimAktif.panen.forEach(p=>{
    riwayat.push({
      tipe:"Panen",
      tanggal:p.tanggal,
      komoditas:p.komoditas,
      omzet:p.nilai,
      biayaPanen:p.biayaPanen||0,
      surplus:p.nilai-(p.biayaPanen||0),
      foto:p.foto
    });
  });
  riwayat.sort((a,b)=>new Date(b.tanggal)-new Date(a.tanggal));
}

function renderRiwayat(){
  const box=document.getElementById("riwayatTransaksi");
  const pag=document.getElementById("pagination");
  box.innerHTML=""; pag.innerHTML="";

  riwayat.slice((page-1)*PER_PAGE,page*PER_PAGE).forEach(r=>{
    box.innerHTML+=`
      <div class="riwayat-item">
        <div class="riwayat-date">${tgl(r.tanggal)}</div>
        ${r.tipe==="Panen"?`
          <div><strong>[Panen] ${r.komoditas}</strong></div>
          <div>Omzet: Rp ${rupiah(r.omzet)}</div>
          <div>Biaya Panen: Rp ${rupiah(r.biayaPanen)}</div>
          <div class="success">Surplus: Rp ${rupiah(r.surplus)}</div>
        `:`
          <div><strong>[Biaya]</strong> ${r.keterangan}</div>
          <div class="danger">Rp ${rupiah(Math.abs(r.nilai))}</div>
        `}
        ${r.foto?`<img src="${r.foto}" class="bukti-foto">`:""}
      </div>`;
  });

  const max=Math.min(5,Math.ceil(riwayat.length/PER_PAGE));
  for(let i=1;i<=max;i++){
    const b=document.createElement("button");
    b.textContent=i;
    if(i===page)b.classList.add("active");
    b.onclick=()=>{page=i;renderRiwayat();document.getElementById("riwayatSection").scrollIntoView({behavior:"smooth"});}
    pag.appendChild(b);
  }
}

/* ===============================
   INIT
================================ */
function renderAll(){
  renderModal();
  renderBiaya();
  renderPanen();
  renderLaba();
  kumpulkanRiwayat();
  page=1;
  renderRiwayat();
}
renderAll();
</script>

</body>
</html>