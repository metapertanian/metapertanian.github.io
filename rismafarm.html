<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RISMA FARM | Bertani, Berbisnis, Berbagi</title>

  <link rel="stylesheet" href="/style.css" />

  <!-- DATA -->
  <script src="/rismafarm.js"></script>

  <!-- NAVBAR -->
  <script src="/navbar2.js"></script>
</head>

<body>

<script>
  renderNavbar("rismafarm", "public");
</script>

<main class="container">

  <!-- HEADER -->
  <section class="bank-header" style="margin-bottom:16px">
    <img src="/img/risma_1.png" class="bank-logo">
    <h1 class="bank-title">RISMA FARM</h1>
    <p class="muted" style="text-align:center">
      Bertani Â· Berbisnis Â· Berbagi
    </p>
  </section>

  <!-- PILIH MUSIM -->
  <section class="card" style="text-align:center">
    <select id="pilihMusim" class="select-center"></select>
  </section>

  <!-- MODAL -->
  <section class="card">
    <h2>ðŸ’¼ Modal</h2>
    <div id="tabelModal"></div>
  </section>

  <!-- TABEL BIAYA -->
  <section class="card">
    <h2>ðŸ’¸ Tabel Biaya</h2>
    <div id="tabelBiaya"></div>
  </section>

  <!-- PANEN PER KOMODITAS -->
  <section class="card">
    <h2>ðŸŒ¾ Panen per Komoditas</h2>
    <div id="tabelPanen"></div>
  </section>

  <!-- LABA -->
  <section id="labaSection"></section>

  <!-- RIWAYAT -->
  <section class="card" id="riwayatSection">
    <h2>ðŸ“œ Riwayat Transaksi</h2>
    <div id="riwayatTransaksi"></div>
    <div class="pagination" id="pagination"></div>
  </section>

</main>

<script>
/* ===============================
   UTIL
================================ */
const rupiah = n => Number(n||0).toLocaleString("id-ID");
const tgl = t => new Date(t).toLocaleDateString("id-ID",{day:"2-digit",month:"long",year:"numeric"});

/* ===============================
   MUSIM
================================ */
const musimKeys = Object.keys(RISMA_FARM.musim||{});
let musimAktif = musimKeys[0];

const selectMusim = document.getElementById("pilihMusim");
musimKeys.forEach(k=>{
  const m = RISMA_FARM.musim[k];
  selectMusim.innerHTML += `<option value="${k}">${m.label}</option>`;
});
selectMusim.onchange = e=>{
  musimAktif = e.target.value;
  renderAll();
};

/* ===============================
   MODAL
================================ */
function renderModal(m){
  let total = 0;
  let html = `<table class="table">
    <tr><th>No</th><th>Pemodal</th><th>Nilai</th></tr>`;
  Object.entries(m.modal||{}).forEach(([n,v],i)=>{
    total += Number(v);
    html += `<tr><td>${i+1}</td><td>${n}</td><td>Rp ${rupiah(v)}</td></tr>`;
  });
  html += `<tr class="total"><td colspan="2">Total</td><td>Rp ${rupiah(total)}</td></tr></table>`;
  document.getElementById("tabelModal").innerHTML = html;
}

/* ===============================
   BIAYA
================================ */
function renderBiaya(m){
  let total=0;
  let html=`<table class="table"><tr><th>No</th><th>Keterangan</th><th>Harga</th></tr>`;
  (m.biaya||[]).forEach((b,i)=>{
    total+=b.jumlah;
    html+=`<tr><td>${i+1}</td><td>${b.keterangan}</td><td>Rp ${rupiah(b.jumlah)}</td></tr>`;
  });
  html+=`<tr class="total"><td colspan="2">Total</td><td>Rp ${rupiah(total)}</td></tr></table>`;
  document.getElementById("tabelBiaya").innerHTML=html;
}

/* ===============================
   PANEN PER KOMODITAS
================================ */
function renderPanen(m){
  const box=document.getElementById("tabelPanen");
  box.innerHTML="";
  const grup={};

  (m.panen||[]).forEach(p=>{
    if(!grup[p.komoditas]) grup[p.komoditas]=[];
    grup[p.komoditas].push(p);
  });

  Object.entries(grup).forEach(([komoditas,list])=>{
    let totalSurplus=0;
    let html=`<h3>${komoditas}</h3><table class="table">
      <tr><th>No</th><th>Tanggal</th><th>Surplus</th></tr>`;
    list.forEach((p,i)=>{
      const s=p.nilai-(p.biayaPanen||0);
      totalSurplus+=s;
      html+=`<tr><td>${i+1}</td><td>${tgl(p.tanggal)}</td><td>Rp ${rupiah(s)}</td></tr>`;
    });
    html+=`<tr class="total"><td colspan="2">Total</td><td>Rp ${rupiah(totalSurplus)}</td></tr></table>`;
    box.innerHTML+=html;
  });
}

/* ===============================
   LABA & BAGI HASIL
================================ */
function renderLaba(m){
  const omzet=(m.panen||[]).reduce((a,b)=>a+b.nilai,0);
  const biaya=(m.biaya||[]).reduce((a,b)=>a+b.jumlah,0);
  const biayaPanen=(m.panen||[]).reduce((a,b)=>a+(b.biayaPanen||0),0);
  const laba=omzet-biaya-biayaPanen;

  let html=`<section class="card"><h2>ðŸ“Š Laba & Bagi Hasil</h2>
    <div class="stat"><strong>Laba Bersih: Rp ${rupiah(laba)}</strong></div>`;

  const skema=m.skema?.pembagian||{};
  Object.entries(skema).forEach(([k,v])=>{
    html+=`<div class="muted">${k}: Rp ${rupiah(laba*v/100)} (${v}%)</div>`;
  });
  html+=`</section>`;
  document.getElementById("labaSection").innerHTML=html;
}

/* ===============================
   RIWAYAT
================================ */
const PER_PAGE=5;
let dataRiwayat=[];

function kumpulkanRiwayat(m){
  dataRiwayat=[];
  (m.biaya||[]).forEach(b=>dataRiwayat.push({
    t:b.tanggal, jenis:"Biaya", judul:b.keterangan,
    nilai:b.jumlah, foto:b.foto||null
  }));
  (m.panen||[]).forEach(p=>dataRiwayat.push({
    t:p.tanggal, jenis:`Panen ${p.komoditas}`,
    omzet:p.nilai, biaya:p.biayaPanen||0,
    surplus:p.nilai-(p.biayaPanen||0),
    foto:p.foto||null
  }));
  dataRiwayat.sort((a,b)=>new Date(b.t)-new Date(a.t));
}

function renderRiwayat(page=1){
  const box=document.getElementById("riwayatTransaksi");
  const pag=document.getElementById("pagination");
  box.innerHTML=""; pag.innerHTML="";

  dataRiwayat.slice((page-1)*PER_PAGE,page*PER_PAGE).forEach(r=>{
    box.innerHTML+=`
      <div class="riwayat-full">
        <small>${tgl(r.t)}</small>
        <h4>${r.jenis}</h4>
        ${r.omzet?`<div>Omzet: Rp ${rupiah(r.omzet)}</div>
        <div>Biaya Panen: Rp ${rupiah(r.biaya)}</div>
        <strong>Surplus: Rp ${rupiah(r.surplus)}</strong>`
        :`<strong>Rp ${rupiah(r.nilai)}</strong>`}
        ${r.foto?`<img src="${r.foto}" class="bukti">`:""}
      </div>`;
  });

  const max=Math.min(5,Math.ceil(dataRiwayat.length/PER_PAGE));
  for(let i=1;i<=max;i++){
    const b=document.createElement("button");
    b.textContent=i;
    if(i===page) b.classList.add("active");
    b.onclick=()=>{renderRiwayat(i);riwayatSection.scrollIntoView({behavior:"smooth"});}
    pag.appendChild(b);
  }
}

/* ===============================
   INIT
================================ */
function renderAll(){
  const m=RISMA_FARM.musim[musimAktif];
  renderModal(m);
  renderBiaya(m);
  renderPanen(m);
  renderLaba(m);
  kumpulkanRiwayat(m);
  renderRiwayat(1);
}
renderAll();
</script>

</body>
</html>