<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RISMA FARM | Bertani, Berbisnis, Berbagi</title>

  <link rel="stylesheet" href="/style.css" />

  <!-- DATA -->
  <script src="/rismafarm.js"></script>

  <!-- NAVBAR -->
  <script src="/navbar2.js"></script>
</head>

<body>

<script>
  renderNavbar("rismafarm", "public");
</script>

<main class="container">

<!-- ======================================================
1. HEADER
====================================================== -->
<section class="bank-header">
  <img src="/img/risma_1.png" class="bank-logo">
  <h1 class="bank-title">RISMA FARM</h1>
  <p class="muted">Bertani Â· Berbisnis Â· Berbagi</p>
</section>

<!-- ======================================================
2. PILIH MUSIM
====================================================== -->
<section class="card" style="text-align:center">
  <select id="pilihMusim" style="max-width:320px;margin:auto"></select>
  <div id="infoMusim" class="muted" style="margin-top:10px"></div>
</section>

<!-- ======================================================
3. MODAL
====================================================== -->
<section class="card">
  <h2>ðŸ’° Investor</h2>
  <div id="tabelModal"></div>
</section>

<!-- ======================================================
4. TABEL BIAYA
====================================================== -->
<section class="card">
  <h2>ðŸ’¸ Biaya & Skincare</h2>
  <div id="tabelBiaya"></div>
</section>

<!-- ======================================================
5. PANEN PER KOMODITAS
====================================================== -->
<section class="card">
  <h2>ðŸŒ¾ Hasil Panen</h2>
  <div id="tabelPanen"></div>
</section>

<!-- ======================================================
6. LABA & BAGI HASIL
====================================================== -->
<section id="labaSection"></section>

<!-- ======================================================
7. RIWAYAT TRANSAKSI
====================================================== -->
<section class="card" id="riwayatSection">
  <h2>ðŸ“œ Riwayat Transaksi</h2>
  <div id="riwayatTransaksi"></div>
  <div class="pagination" id="pagination"></div>
</section>

</main>

<script>
/* ======================================================
UTIL
====================================================== */
const rupiah = n => Number(n||0).toLocaleString("id-ID");
const tgl = t => new Date(t).toLocaleDateString("id-ID",{
  day:"2-digit", month:"short", year:"numeric"
});



/* ======================================================
DATA MUSIM
====================================================== */
const musimKeys = Object.keys(RISMA_FARM.musim || {});
let musimAktif = RISMA_FARM.musim[musimKeys[0]];

/* ======================================================
DROPDOWN MUSIM
====================================================== */
const selectMusim = document.getElementById("pilihMusim");
musimKeys.forEach(k=>{
  const m = RISMA_FARM.musim[k];
  const opt = document.createElement("option");
  opt.value = k;
  opt.textContent = m.label;
  selectMusim.appendChild(opt);
});
selectMusim.onchange = () => {
  musimAktif = RISMA_FARM.musim[selectMusim.value];
  renderSemua();
};

/* ======================================================
INFO MUSIM (HANYA LOKASI)
====================================================== */
function renderInfoMusim(){
  document.getElementById("infoMusim").innerHTML =
    musimAktif.lokasi || "";
}

/* ======================================================
MODAL
====================================================== */
function renderModal(){
  let total = 0;
  let html = `<table class="table">
    <tr><th>No</th><th>Nama</th><th>Jumlah</th></tr>`;
  Object.entries(musimAktif.modal||{}).forEach(([n,v],i)=>{
    total += Number(v);
    html += `<tr>
      <td>${i+1}</td>
      <td>${n}</td>
      <td>Rp ${rupiah(v)}</td>
    </tr>`;
  });
  html += `<tr class="total">
    <td colspan="2"><strong>Total</strong></td>
    <td><strong>Rp ${rupiah(total)}</strong></td>
  </tr></table>`;
  document.getElementById("tabelModal").innerHTML = html;
}

/* ======================================================
TABEL BIAYA
====================================================== */
function renderTabelBiaya(){
  let total = 0;
  let html = `<table class="table">
    <tr><th>No</th><th>Tanggal</th><th>Keterangan</th><th>Harga</th></tr>`;
  const biayaSorted = [...musimAktif.biaya].sort(
  (a,b) => new Date(a.tanggal) - new Date(b.tanggal)
);

biayaSorted.forEach((b,i)=>{
    total += b.jumlah;
    html += `<tr>
      <td>${i+1}</td>
      <td>${tgl(b.tanggal)}</td>
      <td>${b.keterangan}</td>
      <td>Rp ${rupiah(b.jumlah)}</td>
    </tr>`;
  });
  html += `<tr class="total">
    <td colspan="3"><strong>Total</strong></td>
    <td><strong>Rp ${rupiah(total)}</strong></td>
  </tr></table>`;
  document.getElementById("tabelBiaya").innerHTML = html;
}

/* ======================================================
PANEN PER KOMODITAS (DIPISAH)
====================================================== */
function renderTabelPanen(){
  const box = document.getElementById("tabelPanen");
  box.innerHTML = "";

  const grup = {};
  musimAktif.panen.forEach(p=>{
    if(!grup[p.komoditas]) grup[p.komoditas]=[];
    grup[p.komoditas].push(p);
  });

  Object.entries(grup).forEach(([komoditas,data])=>{
    let totalSurplus = 0;
    let html = `<br/><h3 style="margin-top:14px">${komoditas}</h3>
    <table class="table">
      <tr><th>No</th><th>Tanggal</th><th>Surplus</th></tr>`;
    const dataSorted = [...data].sort(
  (a,b) => new Date(a.tanggal) - new Date(b.tanggal)
);

dataSorted.forEach((p,i)=>{
      const surplus = p.nilai - (p.biayaPanen||0);
      totalSurplus += surplus;
      html += `<tr>
        <td>${i+1}</td>
        <td>${tgl(p.tanggal)}</td>
        <td>Rp ${rupiah(surplus)}</td>
      </tr>`;
    });
    html += `<tr class="total">
      <td colspan="2"><strong>Total</strong></td>
      <td><strong>Rp ${rupiah(totalSurplus)}</strong></td>
    </tr></table>`;
    box.innerHTML += html;
  });
}

/* ======================================================
LABA & BAGI HASIL (KAPITAL + PERSEN)
====================================================== */
function renderLaba(){
  const totalBiaya = musimAktif.biaya.reduce((a,b)=>a+b.jumlah,0);
  const totalOmzet = musimAktif.panen.reduce((a,b)=>a+b.nilai,0);
  const totalBiayaPanen = musimAktif.panen.reduce((a,b)=>a+(b.biayaPanen||0),0);
  const laba = totalOmzet - totalBiaya - totalBiayaPanen;

  let html = `<section class="card">
    <h2>ðŸ“Š Bagi Hasil</h2>
    <div class="stat">
      <small>Laba Bersih</small>
      <strong class="success">Rp ${rupiah(laba)}</strong>
    </div>
    <hr style="margin:14px 0">`;

  Object.entries(musimAktif.skema.pembagian||{}).forEach(([n,p])=>{
    html += `<div class="stat">
      <small>${n.toUpperCase()} (${p}%)</small>
      <strong>Rp ${rupiah(laba*p/100)}</strong>
    </div>`;
  });

  html += `</section>`;
  document.getElementById("labaSection").innerHTML = html;
}

/* ======================================================
RIWAYAT TRANSAKSI + FOTO (THUMBNAIL)
====================================================== */
const PER_PAGE = 5;
let riwayat = [];

function kumpulkanRiwayat(){
  riwayat = [];

  musimAktif.biaya.forEach(b=>{
    riwayat.push({
      tanggal:b.tanggal,
      jenis:"Biaya",
      ket:b.keterangan,
      nilai:-b.jumlah,
      bukti:b.bukti||null
    });
  });

  musimAktif.panen.forEach(p=>{
  riwayat.push({
    tanggal: p.tanggal,
    jenis: "Panen",
    ket: `${p.komoditas} | Omzet Rp ${rupiah(p.nilai)} | Biaya Panen Rp ${rupiah(p.biayaPanen||0)}`,
    nilai: p.nilai - (p.biayaPanen||0),
    bukti: p.bukti || null   // âœ… INI KUNCI
  });
});

  riwayat.sort((a,b)=>new Date(b.tanggal)-new Date(a.tanggal));
}

function showImage(src){
  const m=document.createElement("div");
  m.className="img-modal";
  m.innerHTML=`<img src="${src}">`;
  m.onclick=()=>m.remove();
  document.body.appendChild(m);
}





function renderRiwayat(page=1){
  const box=document.getElementById("riwayatTransaksi");
  const pag=document.getElementById("pagination");
  box.innerHTML=""; 
  pag.innerHTML="";

  riwayat.slice((page-1)*PER_PAGE,page*PER_PAGE).forEach(r=>{
    box.innerHTML+=`
    <div class="riwayat-item">

      <div class="riwayat-thumb ${r.bukti ? "" : "empty"}">
        ${
          r.bukti
          ? `<img 
              src="${r.bukti}"
              class="bukti-img"
              loading="lazy"
              alt="Bukti transaksi"
              onclick="showImage(this.src)"
            >`
          : `<span class="no-photo">NO FOTO</span>`
        }
      </div>

      <div>
        <div class="riwayat-date">${tgl(r.tanggal)}</div>
        <div class="riwayat-title">${r.jenis}</div>

        <div class="riwayat-detail">
          ${r.ket.replaceAll(" | ","<br>")}
        </div>

        <div class="riwayat-value ${r.nilai>=0?'success':'danger'}">
          Rp ${rupiah(r.nilai)}
        </div>
      </div>

    </div>`;
  });

  const max=Math.min(5,Math.ceil(riwayat.length/PER_PAGE));
  for(let i=1;i<=max;i++){
    const b=document.createElement("button");
    b.textContent=i;
    if(i===page)b.classList.add("active");
    b.onclick=()=>{
      renderRiwayat(i);
      document.getElementById("riwayatSection")
        .scrollIntoView({behavior:"smooth"});
    };
    pag.appendChild(b);
  }
}

/* ======================================================
INIT
====================================================== */
function renderSemua(){
  renderInfoMusim();
  renderModal();
  renderTabelBiaya();
  renderTabelPanen();
  renderLaba();
  kumpulkanRiwayat();
  renderRiwayat(1);
}
renderSemua();
</script>

</body>
</html>