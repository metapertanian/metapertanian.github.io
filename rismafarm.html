<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RISMA FARM | Bertani, Berbisnis, Berbagi</title>

  <link rel="stylesheet" href="/style.css" />

  <!-- DATA -->
  <script src="/rismafarm.js"></script>

  <!-- NAVBAR -->
  <script src="/navbar2.js"></script>
</head>

<body>

<script>
  renderNavbar("rismafarm", "public");
</script>

<main class="container">

  <!-- HEADER -->
  <section class="bank-header" style="margin-bottom:20px">
    <img src="/img/risma_1.png" class="bank-logo">
    <h1 class="bank-title">RISMA FARM</h1>
    <p class="muted" style="text-align:center">
      Bertani 路 Berbisnis 路 Berbagi
    </p>
  </section>

  <!-- RINGKASAN MUSIM -->
  <section id="ringkasanMusim"></section>

  <!-- RIWAYAT PANEN -->
  <section class="card">
    <h2> Riwayat Panen</h2>
    <div id="riwayatPanen"></div>
    <div class="pagination" id="pagination"></div>
  </section>

</main>

<script>
/* ===============================
   UTIL
================================ */
function rupiah(n) {
  return Number(n || 0).toLocaleString("id-ID");
}

function tanggalIndo(t) {
  return new Date(t).toLocaleDateString("id-ID", {
    day: "2-digit",
    month: "long",
    year: "numeric"
  });
}

/* ===============================
   AMBIL MUSIM (AMAN)
================================ */
const musimList = Object.values(RISMA_FARM.musim || {});

/* ===============================
   RINGKASAN MUSIM
================================ */
function renderRingkasanMusim() {
  const box = document.getElementById("ringkasanMusim");
  box.innerHTML = "";

  musimList.forEach(musim => {

    const totalModal = Object.values(musim.modal || {})
      .map(v => Number(v))
      .reduce((a,b)=>a+b,0);

    const totalBiaya = (musim.biaya || [])
      .reduce((a,b)=>a + Number(b.jumlah || 0),0);

    const totalPanen = (musim.panen || [])
      .reduce((a,b)=>a + Number(b.nilai || 0),0);

    const card = document.createElement("section");
    card.className = "card";
    card.innerHTML = `
      <h3>${musim.label}</h3>
      <p class="muted">${musim.lokasi}</p>

      <div class="grid-3">
        <div class="stat">
          <small>Modal</small>
          <strong>Rp ${rupiah(totalModal)}</strong>
        </div>
        <div class="stat">
          <small>Biaya</small>
          <strong>Rp ${rupiah(totalBiaya)}</strong>
        </div>
        <div class="stat">
          <small>Omzet Panen</small>
          <strong>Rp ${rupiah(totalPanen)}</strong>
        </div>
      </div>
    `;
    box.appendChild(card);
  });
}

/* ===============================
   PANEN + PAGINATION
================================ */
const PER_PAGE = 5;
let currentPage = 1;
let panenGlobal = [];

function kumpulkanPanen() {
  panenGlobal = [];

  musimList.forEach(musim => {
    (musim.panen || []).forEach(p => {
      panenGlobal.push({
        tanggal: p.tanggal,
        komoditas: p.komoditas,
        qty: p.qty,
        satuan: p.satuan,
        nilai: p.nilai,
        musim: musim.label,
        bonus: p.bonusPanen || null
      });
    });
  });

  panenGlobal.sort((a,b)=>new Date(b.tanggal)-new Date(a.tanggal));
}

function renderPanen(page = 1) {
  currentPage = page;
  const box = document.getElementById("riwayatPanen");
  const pag = document.getElementById("pagination");

  box.innerHTML = "";
  pag.innerHTML = "";

  const start = (page - 1) * PER_PAGE;
  const slice = panenGlobal.slice(start, start + PER_PAGE);

  slice.forEach(p => {
    const div = document.createElement("div");
    div.className = "riwayat-item";
    div.innerHTML = `
      <div class="riwayat-date">${tanggalIndo(p.tanggal)}</div>
      <div>
        <strong>${p.komoditas}</strong><br>
        <span class="muted">
          ${p.qty} ${p.satuan} 路 ${p.musim}
        </span>
        <div class="big-number success" style="font-size:1.2rem;margin-top:4px">
          Rp ${rupiah(p.nilai)}
        </div>
        ${
          p.bonus
            ? `<div class="muted" style="font-size:.8rem;margin-top:4px">
                 Bonus: Rp ${rupiah(p.bonus.total)} 路 ${p.bonus.anggota.join(", ")}
              </div>`
            : ""
        }
      </div>
    `;
    box.appendChild(div);
  });

  const totalPage = Math.ceil(panenGlobal.length / PER_PAGE);
  if (totalPage <= 1) return;

  for (let i = 1; i <= totalPage; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    if (i === page) btn.classList.add("active");
    btn.onclick = () => {
      renderPanen(i);
      window.scrollTo({ top: 0, behavior: "smooth" });
    };
    pag.appendChild(btn);
  }
}

/* ===============================
   INIT
================================ */
renderRingkasanMusim();
kumpulkanPanen();
renderPanen(1);
</script>

</body>
</html>