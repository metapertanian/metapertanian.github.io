<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RISMA FARM | Bertani, Berbisnis, Berbagi</title>

  <link rel="stylesheet" href="/style.css" />

  <!-- DATA -->
  <script src="/rismafarm.js"></script>

  <!-- NAVBAR -->
  <script src="/navbar2.js"></script>
</head>

<body>

<script>
  renderNavbar("rismafarm", "public");
</script>

<main class="container">

  <!-- HEADER -->
  <section class="bank-header" style="margin-bottom:20px">
    <img src="/img/risma_1.png" class="bank-logo">
    <h1 class="bank-title">RISMA FARM</h1>
    <p class="muted" style="text-align:center">
      Bertani Â· Berbisnis Â· Berbagi
    </p>
  </section>

  <!-- RINGKASAN MUSIM -->
  <section id="ringkasanMusim"></section>

  <!-- LABA & BAGI HASIL -->
  <section id="labaSection"></section>

  <!-- TABEL BIAYA -->
  <section class="card">
    <h2>ðŸ’¸ Tabel Biaya</h2>
    <div id="tabelBiaya"></div>
  </section>

  <!-- TABEL PANEN -->
  <section class="card">
    <h2>ðŸŒ¾ Panen per Komoditas</h2>
    <div id="tabelPanen"></div>
  </section>

  <!-- RIWAYAT -->
  <section class="card" id="riwayatSection">
    <h2>ðŸ“œ Riwayat Transaksi</h2>
    <div id="riwayatTransaksi"></div>
    <div class="pagination" id="pagination"></div>
  </section>

</main>

<script>
/* ===============================
   UTIL
================================ */
function rupiah(n){
  return Number(n||0).toLocaleString("id-ID");
}
function tgl(t){
  return new Date(t).toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"});
}

/* ===============================
   DATA MUSIM
================================ */
const musimList = Object.values(RISMA_FARM.musim || {});
const musim = musimList[0]; // fokus 1 musim dulu

/* ===============================
   RINGKASAN + LABA
================================ */
function renderRingkasanMusim(){
  const totalModal = Object.values(musim.modal||{}).reduce((a,b)=>a+Number(b),0);
  const totalBiaya = (musim.biaya||[]).reduce((a,b)=>a+Number(b.jumlah||0),0);
  const totalOmzet = (musim.panen||[]).reduce((a,b)=>a+Number(b.nilai||0),0);
  const totalBiayaPanen = (musim.panen||[]).reduce((a,b)=>a+Number(b.biayaPanen||0),0);

  const labaBersih = totalOmzet - totalBiaya - totalBiayaPanen;

  document.getElementById("ringkasanMusim").innerHTML = `
    <section class="card">
      <h3>${musim.label}</h3>
      <div class="grid-3">
        <div class="stat"><small>Modal</small><strong>Rp ${rupiah(totalModal)}</strong></div>
        <div class="stat"><small>Biaya</small><strong>Rp ${rupiah(totalBiaya)}</strong></div>
        <div class="stat"><small>Omzet</small><strong>Rp ${rupiah(totalOmzet)}</strong></div>
      </div>
    </section>
  `;

  const skema = musim.skema.pembagian;
  document.getElementById("labaSection").innerHTML = `
    <section class="card">
      <h2>ðŸ“Š Laba & Bagi Hasil</h2>
      <div class="grid-3">
        <div class="stat"><small>Laba Bersih</small><strong class="success">Rp ${rupiah(labaBersih)}</strong></div>
        <div class="stat"><small>Pelaksana</small><strong>Rp ${rupiah(labaBersih*skema.pelaksana/100)}</strong></div>
        <div class="stat"><small>RISMA</small><strong>Rp ${rupiah(labaBersih*skema.risma/100)}</strong></div>
      </div>
    </section>
  `;
}

/* ===============================
   TABEL BIAYA
================================ */
function renderTabelBiaya(){
  let total = 0;
  let html = `<table class="table">
    <tr><th>No</th><th>Keterangan</th><th>Harga</th></tr>`;
  musim.biaya.forEach((b,i)=>{
    total += b.jumlah;
    html += `<tr>
      <td>${i+1}</td>
      <td>${b.keterangan}</td>
      <td>Rp ${rupiah(b.jumlah)}</td>
    </tr>`;
  });
  html += `<tr class="total">
    <td colspan="2"><strong>Total</strong></td>
    <td><strong>Rp ${rupiah(total)}</strong></td>
  </tr></table>`;
  document.getElementById("tabelBiaya").innerHTML = html;
}

/* ===============================
   TABEL PANEN
================================ */
function renderTabelPanen(){
  let html = `<table class="table">
    <tr><th>No</th><th>Tanggal</th><th>Surplus</th></tr>`;
  musim.panen.forEach((p,i)=>{
    const surplus = p.nilai - (p.biayaPanen||0);
    html += `<tr>
      <td>${i+1}</td>
      <td>${tgl(p.tanggal)}</td>
      <td>Rp ${rupiah(surplus)}</td>
    </tr>`;
  });
  html += `</table>`;
  document.getElementById("tabelPanen").innerHTML = html;
}

/* ===============================
   RIWAYAT GABUNGAN
================================ */
const PER_PAGE = 5;
let transaksi = [];

function kumpulkanRiwayat(){
  transaksi = [];

  musim.biaya.forEach(b=>{
    transaksi.push({
      tanggal:b.tanggal,
      jenis:"Biaya",
      ket:b.keterangan,
      nilai:-b.jumlah
    });
  });

  musim.panen.forEach(p=>{
    const surplus = p.nilai - (p.biayaPanen||0);
    transaksi.push({
      tanggal:p.tanggal,
      jenis:"Panen",
      ket:`${p.komoditas} | Omzet Rp ${rupiah(p.nilai)} | Biaya Panen Rp ${rupiah(p.biayaPanen||0)}`,
      nilai:surplus
    });
  });

  transaksi.sort((a,b)=>new Date(b.tanggal)-new Date(a.tanggal));
}

function renderRiwayat(page=1){
  const box = document.getElementById("riwayatTransaksi");
  const pag = document.getElementById("pagination");
  box.innerHTML = ""; pag.innerHTML="";

  const slice = transaksi.slice((page-1)*PER_PAGE, page*PER_PAGE);
  slice.forEach(t=>{
    box.innerHTML += `
      <div class="riwayat-item">
        <div class="riwayat-date">${tgl(t.tanggal)}</div>
        <div>
          <strong>${t.jenis}</strong>
          <div class="muted">${t.ket}</div>
          <div class="${t.nilai>=0?'success':'danger'}">
            Rp ${rupiah(t.nilai)}
          </div>
        </div>
      </div>`;
  });

  const totalPage = Math.min(5, Math.ceil(transaksi.length/PER_PAGE));
  for(let i=1;i<=totalPage;i++){
    const b=document.createElement("button");
    b.textContent=i;
    if(i===page) b.classList.add("active");
    b.onclick=()=>{
      renderRiwayat(i);
      document.getElementById("riwayatSection").scrollIntoView({behavior:"smooth"});
    };
    pag.appendChild(b);
  }
}

/* ===============================
   INIT
================================ */
renderRingkasanMusim();
renderTabelBiaya();
renderTabelPanen();
kumpulkanRiwayat();
renderRiwayat(1);
</script>

</body>
</html>