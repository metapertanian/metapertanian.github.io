<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RISMA FARM x BERTUNAS | Bertani Berbisnis Berbagi</title>

  <link rel="stylesheet" href="/style.css" />

  <!-- DATA -->
  <script src="/rismafarm.js"></script>

  <!-- NAVBAR -->
  <script src="/navbar2.js"></script>
</head>

<body>

<script>
  renderNavbar("rismafarm", "public");
</script>

<main class="container">

  <!-- HEADER -->
  <section class="hero">
    <h1>ðŸŒ¾ RISMA FARM</h1>
    <p class="tagline">Lahan Utama Produksi & Bagi Hasil</p>
  </section>

  <!-- RINGKASAN MUSIM -->
  <section id="ringkasanMusim"></section>

  <!-- RIWAYAT PANEN -->
  <section class="card">
    <h2>ðŸŒ½ Riwayat Panen</h2>
    <div id="riwayatPanen"></div>
    <div class="pagination" id="pagination"></div>
  </section>

</main>

<script>
/* ===============================
   UTIL
================================ */
function format(num) {
  return Number(num || 0).toLocaleString("id-ID");
}

/* ===============================
   AMBIL MUSIM (AMAN URUTAN)
================================ */
const musimList = Object.values(RISMA_FARM.musim || {});

/* ===============================
   RINGKASAN PER MUSIM
================================ */
function renderRingkasanMusim() {
  const box = document.getElementById("ringkasanMusim");
  box.innerHTML = "";

  musimList.forEach(musim => {
    const totalModal = Object.values(musim.modal || {}).reduce((a, b) => a + b, 0);
    const totalBiaya = (musim.biaya || []).reduce((a, b) => a + b.nilai, 0);
    const totalPanen = (musim.panen || []).reduce((a, b) => a + b.nilai, 0);

    const card = document.createElement("section");
    card.className = "card";
    card.innerHTML = `
      <h3>${musim.label}</h3>
      <div class="grid-3">
        <div class="stat">
          <small>Modal</small>
          <strong>Rp ${format(totalModal)}</strong>
        </div>
        <div class="stat">
          <small>Biaya</small>
          <strong>Rp ${format(totalBiaya)}</strong>
        </div>
        <div class="stat">
          <small>Omzet Panen</small>
          <strong>Rp ${format(totalPanen)}</strong>
        </div>
      </div>
    `;
    box.appendChild(card);
  });
}

/* ===============================
   PANEN + PAGINATION
================================ */
const PER_PAGE = 5;
let currentPage = 1;
let panenGlobal = [];

function ambilPanen() {
  musimList.forEach(musim => {
    (musim.panen || []).forEach(p => {
      panenGlobal.push({
        tanggal: p.tanggal,
        nama: p.nama || p.komoditas,
        qty: p.qty || 0,
        satuan: p.satuan || "kg",
        nilai: p.nilai || 0,
        musim: musim.label
      });
    });
  });

  panenGlobal.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
}

function renderPanen(page = 1) {
  currentPage = page;
  const box = document.getElementById("riwayatPanen");
  const pag = document.getElementById("pagination");

  box.innerHTML = "";
  pag.innerHTML = "";

  const start = (page - 1) * PER_PAGE;
  const slice = panenGlobal.slice(start, start + PER_PAGE);

  slice.forEach(p => {
    const div = document.createElement("div");
    div.className = "panen-card";
    div.innerHTML = `
      <strong>${p.nama}</strong>
      <div class="muted">
        ðŸ“† ${p.tanggal} Â· ${p.qty} ${p.satuan} Â· ${p.musim}
      </div>
      <div class="nilai">
        Rp ${format(p.nilai)}
      </div>
    `;
    box.appendChild(div);
  });

  const totalPage = Math.ceil(panenGlobal.length / PER_PAGE);
  if (totalPage <= 1) return;

  for (let i = 1; i <= totalPage; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    if (i === page) btn.classList.add("active");
    btn.onclick = () => {
      renderPanen(i);
      window.scrollTo({ top: 0, behavior: "smooth" });
    };
    pag.appendChild(btn);
  }
}

/* ===============================
   INIT
================================ */
renderRingkasanMusim();
ambilPanen();
renderPanen(1);
</script>

</body>
</html>