<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BERTUNAS â€“ Bertani, Berbisnis, Berbagi</title>

  <link rel="stylesheet" href="/style.css" />

  <!-- DATA LAHAN -->
  <script src="/rismafarm.js"></script>
  <script src="/umi.js"></script>
  <script src="/umi2.js"></script>

  <!-- NAVBAR -->
  <script src="/navbar2.js"></script>
</head>

<body>

<script>
  renderNavbar("bertunas", "public");
</script>

<main class="container">

  <!-- HEADER -->
  <section class="hero">
    <h1>BERTUNAS</h1>
    <p class="tagline">Bertani, Berbisnis, Berbagi</p>
  </section>

  <!-- RINGKASAN TONASE -->
  <section class="grid-3" id="ringkasanTonase">
    <!-- diisi JS -->
  </section>

  <!-- RIWAYAT PANEN -->
  <section class="card">
    <h2>ðŸŒ¾ Riwayat Panen Terbaru</h2>
    <div id="riwayatPanen"></div>
    <div class="pagination" id="pagination"></div>
  </section>

</main>

<script>
/* ===============================
   UTIL DATA PANEN
================================ */
function ambilSemuaPanen() {
  const lahanList = [
    typeof RISMA_FARM !== "undefined" ? RISMA_FARM : null,
    typeof UMI !== "undefined" ? UMI : null,
    typeof UMI2 !== "undefined" ? UMI2 : null,
  ].filter(Boolean);

  let semua = [];

  lahanList.forEach(lahan => {
    Object.values(lahan.musim || {}).forEach(musim => {
      (musim.panen || []).forEach(p => {
        semua.push({
          tanggal: p.tanggal,
          nama: p.nama || p.komoditas,
          qty: p.qty || 0,
          satuan: p.satuan || "kg",
          nilai: p.nilai || 0,
          lahan: lahan.nama
        });
      });
    });
  });

  return semua;
}

/* ===============================
   ANIMASI ANGKA
================================ */
function animateNumber(el, end) {
  let start = 0;
  const duration = 3000;
  const startTime = performance.now();

  function step(now) {
    const progress = Math.min((now - startTime) / duration, 1);
    const value = Math.floor(progress * end);
    el.textContent = value.toLocaleString("id-ID");
    if (progress < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* ===============================
   RINGKASAN TONASE
================================ */
function renderRingkasan(panen) {
  const map = {};

  panen.forEach(p => {
    if (!map[p.nama]) map[p.nama] = 0;
    map[p.nama] += p.qty;
  });

  const box = document.getElementById("ringkasanTonase");
  box.innerHTML = "";

  Object.entries(map).forEach(([komoditas, total]) => {
    const card = document.createElement("div");
    card.className = "card center";
    card.innerHTML = `
      <h3>${komoditas}</h3>
      <div class="big-number">0</div>
      <small>kg</small>
    `;
    box.appendChild(card);
    animateNumber(card.querySelector(".big-number"), total);
  });
}

/* ===============================
   PAGINATION RIWAYAT PANEN
================================ */
const PER_PAGE = 5;
let currentPage = 1;
let dataGlobal = [];

function renderRiwayatPagination(data) {
  dataGlobal = data.sort(
    (a, b) => new Date(b.tanggal) - new Date(a.tanggal)
  );
  renderPage(1);
}

function renderPage(page) {
  currentPage = page;

  const box = document.getElementById("riwayatPanen");
  const pag = document.getElementById("pagination");
  box.innerHTML = "";
  pag.innerHTML = "";

  const start = (page - 1) * PER_PAGE;
  const slice = dataGlobal.slice(start, start + PER_PAGE);

  slice.forEach(p => {
    const div = document.createElement("div");
    div.className = "panen-card";
    div.innerHTML = `
      <strong>${p.nama}</strong>
      <div class="muted">
        ðŸ“† ${p.tanggal} Â· ${p.qty} ${p.satuan} Â· ${p.lahan}
      </div>
      <div class="nilai">
        Rp ${p.nilai.toLocaleString("id-ID")}
      </div>
    `;
    box.appendChild(div);
  });

  const totalPage = Math.ceil(dataGlobal.length / PER_PAGE);
  if (totalPage <= 1) return;

  if (page > 1) {
    pag.innerHTML += `<button onclick="gotoPage(${page - 1})">â€¹</button>`;
  }

  for (let i = 1; i <= totalPage; i++) {
    pag.innerHTML += `
      <button class="${i === page ? 'active' : ''}"
        onclick="gotoPage(${i})">${i}</button>
    `;
  }

  if (page < totalPage) {
    pag.innerHTML += `<button onclick="gotoPage(${page + 1})">â€º</button>`;
  }
}

function gotoPage(page) {
  renderPage(page);
  window.scrollTo({ top: 0, behavior: "smooth" });
}

/* ===============================
   INIT
================================ */
const semuaPanen = ambilSemuaPanen();
renderRingkasan(semuaPanen);
renderRiwayatPagination(semuaPanen);
</script>

</body>
</html>